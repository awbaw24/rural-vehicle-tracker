<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë†ì–´ì´Œ ì°¨ëŸ‰ ì¶”ì  ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Google Maps JavaScript API -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=geometry">
    </script>
    <style>
      /* ì§€ë„ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
      .map-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #e5e7eb;
      }
      
      /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
      .custom-marker {
        background: #dc2626;
        border: 3px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      function RuralVehicleTracker() {
        const [isTracking, setIsTracking] = useState(false);
        
        // ì‹¤ì œ GPS ì—°ë™
        const [position, setPosition] = useState({
          latitude: null,
          longitude: null,
          timestamp: null,
          accuracy: null,
          error: null
        });

        const [watchId, setWatchId] = useState(null);
        const [map, setMap] = useState(null);
        const [marker, setMarker] = useState(null);
        const [locationHistory, setLocationHistory] = useState([]);
        const [isOnline, setIsOnline] = useState(navigator.onLine);
        const [vehicleId, setVehicleId] = useState('');
        const mapRef = useRef(null);

        // Firebase ì„¤ì •
        const firebaseConfig = {
          // ì—¬ê¸°ì— Firebase í”„ë¡œì íŠ¸ ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”
          apiKey: "YOUR_FIREBASE_API_KEY",
          authDomain: "your-project.firebaseapp.com",
          projectId: "your-project-id",
          storageBucket: "your-project.appspot.com",
          messagingSenderId: "123456789",
          appId: "your-app-id"
        };

        // Firebase ì´ˆê¸°í™”
        const initFirebase = () => {
          if (!window.firebase || window.firebase.apps.length > 0) return;
          
          try {
            window.firebase.initializeApp(firebaseConfig);
            console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
          } catch (error) {
            console.log('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜ (ì„¤ì • í•„ìš”):', error);
          }
        };

        // Firestoreì— ìœ„ì¹˜ ë°ì´í„° ì €ì¥
        const saveLocationToFirebase = async (locationData) => {
          if (!window.firebase || !window.firebase.apps.length) return;
          
          try {
            const db = window.firebase.firestore();
            const docRef = await db.collection('vehicle_locations').add({
              vehicleId: vehicleId || 'unknown_vehicle',
              latitude: locationData.latitude,
              longitude: locationData.longitude,
              accuracy: locationData.accuracy,
              timestamp: window.firebase.firestore.FieldValue.serverTimestamp(),
              localTime: locationData.timestamp
            });
            
            console.log('ìœ„ì¹˜ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', docRef.id);
          } catch (error) {
            console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', error);
          }
        };

        // ì˜¨ë¼ì¸ ìƒíƒœ ê°ì§€
        useEffect(() => {
          const handleOnline = () => setIsOnline(true);
          const handleOffline = () => setIsOnline(false);
          
          window.addEventListener('online', handleOnline);
          window.addEventListener('offline', handleOffline);
          
          return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
          };
        }, []);

        // Google Maps ì´ˆê¸°í™”
        const initializeMap = (lat, lng) => {
          if (!window.google || !mapRef.current) return;

          const mapOptions = {
            center: { lat: lat, lng: lng },
            zoom: 16,
            mapTypeId: window.google.maps.MapTypeId.HYBRID, // ìœ„ì„± ì§€ë„
            disableDefaultUI: false,
            zoomControl: true,
            streetViewControl: false,
            fullscreenControl: true,
          };

          const newMap = new window.google.maps.Map(mapRef.current, mapOptions);
          
          // ì°¨ëŸ‰ ë§ˆì»¤ ì¶”ê°€
          const newMarker = new window.google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: newMap,
            title: 'ë†ì–´ì´Œ ì°¨ëŸ‰ ìœ„ì¹˜',
            icon: {
              path: window.google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: '#dc2626',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 3,
            },
            animation: window.google.maps.Animation.DROP
          });

          // ì •í™•ë„ ì› ì¶”ê°€
          const accuracyCircle = new window.google.maps.Circle({
            strokeColor: '#3b82f6',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#3b82f6',
            fillOpacity: 0.2,
            map: newMap,
            center: { lat: lat, lng: lng },
            radius: position.accuracy || 50
          });

          setMap(newMap);
          setMarker(newMarker);
        };

        // ì§€ë„ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        const updateMapPosition = (lat, lng) => {
          if (map && marker) {
            const newPosition = { lat: lat, lng: lng };
            marker.setPosition(newPosition);
            map.setCenter(newPosition);
            
            // ë§ˆì»¤ ì• ë‹ˆë©”ì´ì…˜
            marker.setAnimation(window.google.maps.Animation.BOUNCE);
            setTimeout(() => {
              marker.setAnimation(null);
            }, 2000);
          }
        };

        // ì‹¤ì œ GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        const getCurrentPosition = () => {
          if (!navigator.geolocation) {
            setPosition(prev => ({
              ...prev,
              error: 'GPSê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤'
            }));
            return;
          }

          const options = {
            enableHighAccuracy: true, // ê³ ì •ë°€ GPS ì‚¬ìš©
            timeout: 10000, // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            maximumAge: 0 // ìºì‹œëœ ìœ„ì¹˜ ì‚¬ìš© ì•ˆí•¨
          };

          const success = (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            const newPosition = {
              latitude: latitude,
              longitude: longitude,
              timestamp: new Date().toLocaleTimeString(),
              accuracy: Math.round(accuracy),
              error: null
            };
            
            setPosition(newPosition);
            
            // ìœ„ì¹˜ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            setLocationHistory(prev => [...prev, {
              ...newPosition,
              id: Date.now()
            }].slice(-50)); // ìµœê·¼ 50ê°œë§Œ ìœ ì§€
            
            // Firebaseì— ì €ì¥ (ì˜¨ë¼ì¸ ìƒíƒœì¼ ë•Œë§Œ)
            if (isOnline) {
              saveLocationToFirebase(newPosition);
            }
            
            // ì§€ë„ ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
            if (!map) {
              setTimeout(() => initializeMap(latitude, longitude), 100);
            } else {
              updateMapPosition(latitude, longitude);
            }
          };

          const error = (err) => {
            let errorMessage = '';
            switch(err.code) {
              case err.PERMISSION_DENIED:
                errorMessage = "ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤";
                break;
              case err.POSITION_UNAVAILABLE:
                errorMessage = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
                break;
              case err.TIMEOUT:
                errorMessage = "ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤";
                break;
              default:
                errorMessage = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";
                break;
            }
            setPosition(prev => ({
              ...prev,
              error: errorMessage
            }));
          };

          if (isTracking) {
            // ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
            const id = navigator.geolocation.watchPosition(success, error, options);
            setWatchId(id);
          } else {
            // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
            if (watchId) {
              navigator.geolocation.clearWatch(watchId);
              setWatchId(null);
            }
          }
        };

        useEffect(() => {
          // Firebase ì´ˆê¸°í™”
          initFirebase();
          
          getCurrentPosition();
          
          // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì¶”ì  ì¤‘ì§€
          return () => {
            if (watchId) {
              navigator.geolocation.clearWatch(watchId);
            }
          };
        }, [isTracking]);

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
            <div className="max-w-md mx-auto space-y-6">
              
              {/* í—¤ë” */}
              <div className="text-center">
                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                  ğŸŒ¾ ë†ì–´ì´Œ ì°¨ëŸ‰ ì¶”ì 
                </h1>
                <p className="text-gray-600">ì‹¤ì‹œê°„ GPS ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§</p>
              </div>

              {/* í†µí•© ì„¤ì • ì•ˆë‚´ */}
              <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h4 className="font-semibold text-gray-800 mb-3">
                  âš™ï¸ ì™„ì „í•œ ê¸°ëŠ¥ í™œì„±í™” ì„¤ì • ê°€ì´ë“œ
                </h4>
                
                {/* Google Maps ì„¤ì • */}
                <div className="mb-4">
                  <h5 className="font-medium text-blue-800 mb-1">ğŸ—ºï¸ Google Maps API</h5>
                  <div className="text-blue-700 text-sm space-y-1 pl-4">
                    <p>â€¢ Google Cloud Console â†’ Maps JavaScript API í™œì„±í™”</p>
                    <p>â€¢ API í‚¤ ìƒì„± â†’ <code className="bg-blue-200 px-1 rounded">YOUR_API_KEY</code> êµì²´</p>
                  </div>
                </div>
                
                {/* Firebase ì„¤ì • */}
                <div>
                  <h5 className="font-medium text-purple-800 mb-1">ğŸ”¥ Firebase Database</h5>
                  <div className="text-purple-700 text-sm space-y-1 pl-4">
                    <p>â€¢ Firebase Console â†’ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</p>
                    <p>â€¢ Firestore Database í™œì„±í™”</p>
                    <p>â€¢ ì›¹ ì•± ë“±ë¡ â†’ <code className="bg-purple-200 px-1 rounded">firebaseConfig</code> êµì²´</p>
                  </div>
                </div>
                
                <div className="mt-3 p-2 bg-green-100 rounded text-xs text-green-700">
                  ğŸ’¡ ë‘ ì„œë¹„ìŠ¤ ëª¨ë‘ ë¬´ë£Œ ìš”ê¸ˆì œë¡œ ì¶©ë¶„íˆ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!
                </div>
              </div>

              {/* ì°¨ëŸ‰ ì •ë³´ ì„¤ì • */}
              <div className="bg-white border border-gray-200 rounded-lg p-4 mb-6">
                <h4 className="font-semibold text-gray-800 mb-3">
                  ğŸšœ ì°¨ëŸ‰ ì •ë³´ ì„¤ì •
                </h4>
                
                <div className="flex items-center space-x-4">
                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ì°¨ëŸ‰ ì‹ë³„ë²ˆí˜¸:
                    </label>
                    <input
                      type="text"
                      value={vehicleId}
                      onChange={(e) => setVehicleId(e.target.value)}
                      placeholder="ì˜ˆ: ë†ê¸°ê³„001, íŠ¸ë™í„°Aí˜¸, ë§ˆì„ë²„ìŠ¤"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                  </div>
                  
                  {/* ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ */}
                  <div className="flex items-center">
                    <div className={`w-3 h-3 rounded-full mr-2 ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                    <span className="text-sm text-gray-600">
                      {isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'}
                    </span>
                  </div>
                </div>
              </div>

              {/* GPS ê¶Œí•œ ì•ˆë‚´ */}
              {!isTracking && (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                  <h4 className="font-semibold text-yellow-800 mb-2">
                    ğŸ“± GPS ì‚¬ìš© ì¤€ë¹„ì‚¬í•­
                  </h4>
                  <ul className="text-yellow-700 text-sm space-y-1">
                    <li>â€¢ ë¸Œë¼ìš°ì €ì—ì„œ <strong>"ìœ„ì¹˜ ê¶Œí•œ í—ˆìš©"</strong> í´ë¦­</li>
                    <li>â€¢ WiFië³´ë‹¤ëŠ” <strong>ëª¨ë°”ì¼ ë°ì´í„°</strong> ê¶Œì¥</li>
                    <li>â€¢ ì‹¤ì™¸ì—ì„œ ì‚¬ìš© ì‹œ ë” ì •í™•í•œ GPS ì‹ í˜¸</li>
                  </ul>
                </div>
              )}

              {/* ì¶”ì  ì œì–´ ë²„íŠ¼ */}
              <div className="bg-white rounded-lg p-6 shadow-lg">
                <button
                  onClick={() => setIsTracking(!isTracking)}
                  className={`w-full py-4 px-6 rounded-lg font-semibold text-lg transition-all ${
                    isTracking 
                      ? 'bg-red-500 hover:bg-red-600 text-white' 
                      : 'bg-green-500 hover:bg-green-600 text-white'
                  }`}
                >
                  {isTracking ? 'â¹ï¸ ì¶”ì  ì¤‘ì§€' : 'â–¶ï¸ ì¶”ì  ì‹œì‘'}
                </button>
                
                <div className="mt-4 text-center">
                  <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm ${
                    isTracking 
                      ? 'bg-red-100 text-red-600' 
                      : 'bg-gray-100 text-gray-600'
                  }`}>
                    {isTracking ? 'ğŸ”´ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ì¤‘...' : 'âš« ì¶”ì  ëŒ€ê¸° ì¤‘'}
                  </span>
                </div>
              </div>

              {/* ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ */}
              {isTracking && (
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4">
                    ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´
                  </h3>
                  
                  {position.error ? (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p className="text-red-600">âŒ {position.error}</p>
                      <p className="text-sm text-red-500 mt-2">
                        ğŸ’¡ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
                      </p>
                    </div>
                  ) : position.latitude ? (
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-gray-600">ìœ„ë„:</span>
                        <span className="font-mono text-blue-600">
                          {position.latitude.toFixed(6)}Â°
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">ê²½ë„:</span>
                        <span className="font-mono text-blue-600">
                          {position.longitude.toFixed(6)}Â°
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">ì •í™•ë„:</span>
                        <span className="font-mono text-green-600">
                          Â±{position.accuracy}m
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">ì—…ë°ì´íŠ¸:</span>
                        <span className="font-mono text-purple-600">
                          {position.timestamp}
                        </span>
                      </div>
                      
                      {/* êµ¬ê¸€ ë§µ ë§í¬ */}
                      <div className="mt-4 pt-4 border-t border-gray-200">
                        <a 
                          href={`https://maps.google.com/?q=${position.latitude},${position.longitude}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                          ğŸ—ºï¸ êµ¬ê¸€ë§µì—ì„œ ë³´ê¸°
                        </a>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <p className="text-yellow-600">ğŸ“¡ GPS ì‹ í˜¸ë¥¼ ì°¾ëŠ” ì¤‘...</p>
                      <div className="mt-2 bg-yellow-200 rounded-full h-2">
                        <div className="bg-yellow-500 h-2 rounded-full animate-pulse w-1/2"></div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* ìœ„ì¹˜ íˆìŠ¤í† ë¦¬ */}
              {isTracking && locationHistory.length > 0 && (
                <div className="bg-white rounded-lg p-6 shadow-lg">
                  <h3 className="text-lg font-semibold text-gray-800 mb-4">
                    ğŸ“Š ìœ„ì¹˜ íˆìŠ¤í† ë¦¬ ({locationHistory.length}ê°œ)
                  </h3>
                  
                  <div className="max-h-64 overflow-y-auto space-y-2">
                    {locationHistory.slice(-10).reverse().map((loc) => (
                      <div key={loc.id} className="bg-gray-50 rounded-lg p-3 text-sm">
                        <div className="flex justify-between items-center">
                          <span className="font-mono text-blue-600">
                            {loc.latitude.toFixed(4)}Â°, {loc.longitude.toFixed(4)}Â°
                          </span>
                          <span className="text-gray-500">{loc.timestamp}</span>
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                          ì •í™•ë„: Â±{loc.accuracy}m | 
                          {isOnline ? ' ğŸ”¥ ì €ì¥ë¨' : ' ğŸ“± ë¡œì»¬ ì €ì¥'}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {locationHistory.length > 10 && (
                    <div className="text-center mt-3 text-sm text-gray-500">
                      ìµœê·¼ 10ê°œ í‘œì‹œ (ì „ì²´ {locationHistory.length}ê°œ ê¸°ë¡ë¨)
                    </div>
                  )}
                </div>
              )}

              {/* ì‹¤ì‹œê°„ Google Maps */}
              <div className="bg-white rounded-lg p-6 shadow-lg">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">
                  ğŸ—ºï¸ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì§€ë„
                </h3>
                
                {position.latitude ? (
                  <div>
                    <div ref={mapRef} className="map-container mb-4"></div>
                    <div className="text-center text-sm text-gray-600">
                      ğŸ›°ï¸ ìœ„ì„± ì§€ë„ | ë¹¨ê°„ ì : í˜„ì¬ ì°¨ëŸ‰ ìœ„ì¹˜ | íŒŒë€ ì›: GPS ì •í™•ë„ ë²”ìœ„
                    </div>
                  </div>
                ) : (
                  <div className="map-container bg-gray-100 flex items-center justify-center">
                    <div className="text-center">
                      <div className="text-4xl mb-2">ğŸ—ºï¸</div>
                      <p className="text-gray-500">GPS ì‹ í˜¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                      <p className="text-xs text-gray-400 mt-1">
                        ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ì§€ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤
                      </p>
                    </div>
                  </div>
                )}
              </div>

            </div>
          </div>
        );
      }

      ReactDOM.render(<RuralVehicleTracker />, document.getElementById('root'));
    </script>
</body>
</html>
